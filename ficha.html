<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ficha Interativa - Alfa: O Despertar</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  /* Variáveis de cor e layout, baseadas no Alfa 6 original */
  :root { --bg:#121212; --card:#1e1e1e; --muted:#9aa0a6; --acc:#ffd700; --ok:#00d084; --warn:#ffb300; --bad:#ff5252; --text:#f2f2f2; --input-bg:#111; --border-color:#333; }
  * { box-sizing: border-box; }
  body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui, Arial, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-osx-smoothing: grayscale; }
  header { padding:14px 16px; background:#0d0d0d; position:sticky; top:0; z-index:10; border-bottom:1px solid #222; display: flex; justify-content: space-between; align-items: center; }
  header h1 { margin:0; font-size:18px; color:var(--acc); text-align:center; flex-grow: 1; }
  .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
  }
  .header-content a {
    text-decoration: none;
    color: #fff;
    background-color: #4a5568;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
  }
  .header-content a:hover {
    background-color: #fbd38d;
    color: #2d3748;
  }
  main { padding:12px; display:grid; gap:12px; max-width:900px; margin:0 auto; }
  .card { background:var(--card); border:1px solid #2a2a2a; border-radius:12px; padding:12px; }
  .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .col { flex:1; min-width:140px; }
  label { font-size:12px; color:var(--muted); display:block; margin-bottom:4px; }
  input, select, textarea { width:100%; padding:10px; border-radius:10px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text); font-size:14px; }
  textarea { min-height:70px; resize:vertical; }
  input[type=number] { -moz-appearance: textfield; }
  input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .btn { display:inline-flex; align-items:center; justify-content:center; gap:6px; border:0; border-radius:10px; padding:10px 12px; font-weight:700; background:var(--acc); color:#000; cursor:pointer; transition: background-color 0.2s, transform 0.1s; }
  .btn:hover { background: #ffea70; }
  .btn:active { transform: scale(0.98); }
  .btn.ghost { background:#2b2b2b; color:var(--text); border:1px solid #3a3a3a; }
  .btn.danger { background:var(--bad); color:#fff; }
  .btn.ok { background:var(--ok); color:#000; }
  .btn.warn { background:var(--warn); color:#000; }
  .btn.ghost:hover { background: #3c3c3c; }
  .counter { display:flex; align-items:center; gap:8px; }
  .counter .val { min-width:36px; text-align:center; font-weight:700; }
  .tag { padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; display:inline-block; }
  .tag.ok { background:rgba(0,208,132,.15); color:var(--ok); border:1px solid rgba(0,208,132,.35); }
  .tag.warn { background:rgba(255,179,0,.15); color:var(--warn); border:1px solid rgba(255,179,0,.35); }
  .tag.bad { background:rgba(255,82,82,.15); color:var(--bad); border:1-px solid rgba(255,82,82,.35); }
  .list { display:grid; gap:8px; }
  .item { padding:10px; border:1px solid #333; border-radius:10px; background:#161616; }
  .item h4 { margin:0 0 6px 0; font-size:15px; }
  .muted { color:var(--muted); font-size:12px; }
  .dice-area { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .die { width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:10px; background:#0f0f0f; border:1px solid #2b2b2b; font-weight:800; font-size:16px; cursor:pointer; transition: transform 0.1s; }
  .die:hover { transform: translateY(-2px); }
  .die.six { border-color:var(--ok); }
  .die.one { border-color:var(--bad); }
  .result { margin-top:8px; padding:10px; border-radius:10px; background:#101010; border:1px solid #2a2a2a; }
  .result h3 { margin:0 0 6px 0; }
  .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .actions { display:flex; gap:8px; flex-wrap:wrap; }
  .sep { height:1px; background:#2a2a2a; margin:8px 0; }
  .small { font-size:12px; }
  .right { margin-left:auto; }
  .wrap { flex-wrap:wrap; }
  .profile-pic { width: 100px; height: 100px; border-radius: 8px; object-fit: cover; margin-right: 12px; }
  
  /* Novos estilos para os modais */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); z-index: 1000;
    display: none; justify-content: center; align-items: center;
  }
  .modal-content {
    background: var(--card); border: 1-px solid #4a4a4a; border-radius: 12px;
    padding: 16px; width: 90%; max-width: 500px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
  .modal-content h3 { margin-top: 0; }
  
  /* Modal de características fixo */
  .modal-with-scroll .modal-content {
    max-height: 80vh;
    overflow-y: auto;
  }
  
  /* Toggle Switch */
  .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
  .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: var(--ok); }
  input:checked + .slider:before { transform: translateX(26px); }
  .slider-text { position: absolute; color: white; font-size: 10px; line-height: 34px; width: 100%; text-align: center; }

  /* Image Cropper */
  .image-cropper-container {
    width: 300px;
    height: 300px;
    position: relative;
    overflow: hidden;
    margin: 0 auto 16px auto;
    border: 2px solid white; /* Moldura para indicar o enquadramento */
    border-radius: 8px;
  }
  .image-cropper-container img {
    position: absolute;
    cursor: grab;
    touch-action: none; /* Previne o scroll em mobile */
    /* FIX: Ensure image fills container and is zoomable */
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .image-cropper-container img.is-dragging {
    cursor: grabbing;
  }

  .move-btn-group {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 5px;
      margin-top: 10px;
  }

  .move-btn {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 30px;
      height: 30px;
      background: #2b2b2b;
      color: var(--text);
      border: 1px solid #3a3a3a;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      user-select: none;
  }
  .move-btn:hover { background-color: #3c3c3c; }
  .move-btn:active { transform: scale(0.95); }
  .move-btn.up { grid-area: 1 / 2 / 2 / 3; }
  .move-btn.left { grid-area: 2 / 1 / 3 / 2; }
  .move-btn.center { grid-area: 2 / 2 / 3 / 3; }
  .move-btn.right { grid-area: 2 / 3 / 3 / 4; }
  .move-btn.down { grid-area: 3 / 2 / 4 / 3; }
  
  /* Styles for collapsible trees */
  .arvore-header {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
  }
  .arvore-header h3 {
      margin: 0;
      flex: 1;
  }
  .arvore-header .toggle-icon {
      font-size: 1.5rem;
      transition: transform 0.2s;
  }
  .arvore-header.collapsed .toggle-icon {
      transform: rotate(-90deg);
  }
  .arvore-content {
      overflow: hidden;
      transition: all 0.3s ease-in-out;
  }
  .arvore-content.collapsed {
      max-height: 0;
      padding: 0;
      opacity: 0;
      margin-top: 0;
      pointer-events: none;
  }
</style>
</head>
<body>
<header>
    <div class="header-content">
        <h1>Ficha Interativa - Alfa: O Despertar</h1>
        <a href="index.html" class="nav-button">Voltar ao Início</a>
    </div>
</header>
<main id="ficha-geral">

  <!-- Modais -->
  <div id="alert-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 id="alert-title"></h3>
      <p id="alert-text"></p>
      <div class="actions" style="margin-top: 12px;">
        <button class="btn ok" onclick="hideAlertMessage()">Fechar</button>
      </div>
    </div>
  </div>

  <div id="caracteristica-modal" class="modal-overlay">
    <div class="modal-content">
      <h3>Escolha uma Característica</h3>
      <p class="muted small">Você obteve um Sucesso Crítico com uma habilidade de Nível 3 ou superior. Escolha uma Característica para adicionar a ela.</p>
      <div id="caracteristica-options" class="list" style="margin-top: 10px;"></div>
      <div class="actions" style="margin-top: 12px;">
        <button class="btn ghost" onclick="cancelarEscolha()">Cancelar</button>
      </div>
    </div>
  </div>
  
  <div id="manual-modal" class="modal-overlay">
    <div class="modal-content">
      <h3>Ferramentas Manuais</h3>
      <p class="muted small">Selecione uma árvore e a ação desejada.</p>
      <div class="col" style="margin-bottom: 12px;">
        <label for="manual_arvore">Selecionar Árvore</label>
        <select id="manual_arvore" onchange="checkManualOptions()"></select>
      </div>
      <div class="actions" id="manual-options" style="display: none;">
        <button class="btn ok" id="btn-add-level" onclick="addLevelManually()">Adicionar Nível</button>
        <button class="btn ok" id="btn-add-carac" onclick="openManualCaracModal()">Adicionar Característica</button>
      </div>
      <div class="actions" style="margin-top: 12px;">
        <button class="btn ghost" onclick="hideManualModal()">Cancelar</button>
      </div>
    </div>
  </div>
  
  <div id="arvore-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Nova Árvore de Habilidade</h3>
        <p class="muted small">Escolha uma categoria para a nova árvore.</p>
        <div class="list" id="arvore-options" style="margin-top: 10px;">
          <button class="btn ok" onclick="addArvoreFinal('Ataque', 'Ataque')">Ataque</button>
          <button class="btn ok" onclick="addArvoreFinal('Defesa', 'Defesa')">Defesa</button>
          <button class="btn ok" onclick="addArvoreFinal('Suporte', 'Suporte')">Suporte</button>
        </div>
        <div class="sep"></div>
        <div class="col" style="margin-top: 12px;">
            <label for="arvore_nome_custom">Nome da Árvore Adicional</label>
            <input id="arvore_nome_custom" placeholder="Ex: Magia Negra" />
        </div>
        <div class="actions" style="margin-top: 12px;">
            <button class="btn" onclick="addArvoreFinal('Adicional', L('arvore_nome_custom').value)">Adicionar Árvore</button>
            <button class="btn ghost" onclick="hideArvoreModal()">Cancelar</button>
        </div>
    </div>
  </div>
  
  <div id="manual-carac-modal" class="modal-overlay">
    <div class="modal-content">
      <h3>Adicionar Característica</h3>
      <p class="muted small">Selecione uma característica para a habilidade.</p>
      <div class="col" style="margin-bottom: 12px;">
          <label for="manual_arvore_carac">Selecionar Árvore</label>
          <select id="manual_arvore_carac" onchange="renderManualCaracOptions()"></select>
      </div>
      <div class="col" style="margin-bottom: 12px;">
          <label for="manual_hab_carac">Selecionar Habilidade</label>
          <select id="manual_hab_carac" onchange="renderManualCaracOptions()"></select>
      </div>
      <div id="manual-carac-options"></div>
      <div class="actions" style="margin-top: 12px;">
        <button class="btn ghost" onclick="hideManualCaracModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Novo modal para exibir todas as características -->
  <div id="all-caracteristicas-modal" class="modal-overlay modal-with-scroll">
    <div class="modal-content">
      <h3>Características Disponíveis</h3>
      <div id="all-caracteristicas-list" class="list" style="margin-top: 10px;"></div>
      <div class="actions" style="margin-top: 12px;">
        <button class="btn ok" onclick="hideAllCaracteristicasModal()">Fechar</button>
      </div>
    </div>
  </div>

  <div id="xp-modal" class="modal-overlay">
    <div class="modal-content">
      <h3>Adicionar <span id="xp-value"></span> XP</h3>
      <p class="muted small">Selecione o motivo pelo qual você ganhou XP.</p>
      <div id="xp-reason-buttons" class="list" style="margin-top: 10px;">
        <button class="btn ok" onclick="addXpWithReason('Derrotar Monstros: Pequeno')">Derrotar Monstros (Pequeno)</button>
        <button class="btn ok" onclick="addXpWithReason('Derrotar Monstros: Médio')">Derrotar Monstros (Médio)</button>
        <button class="btn ok" onclick="addXpWithReason('Completar Missão: Principal')">Completar Missão (Principal)</button>
        <button class="btn ok" onclick="addXpWithReason('Completar Missão: Secundária')">Completar Missão (Secundária)</button>
        <button class="btn ok" onclick="addXpWithReason('Interpretação Memorável')">Uso Criativo de Habilidade</button>
        <button class="btn ok" onclick="addXpWithReason('Uso Criativo de Habilidade')">Interpretação Memorável</button>
      </div>
      <div style="margin-top: 12px;">
        <label for="xp-other-reason">Outro (especifique)</label>
        <input id="xp-other-reason" placeholder="Ex.: Enigma resolvido" />
      </div>
      <div class="actions" style="margin-top: 12px;">
        <button class="btn ok" onclick="addXpWithReason(L('xp-other-reason').value)">Adicionar</button>
        <button class="btn ghost" onclick="hideXpModal()">Cancelar</button>
      </div>
    </div>
  </div>
  <div id="xp-history-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Histórico de XP</h3>
        <div id="xp-history-list" class="list" style="margin-top: 10px;"></div>
        <div class="actions" style="margin-top: 12px;">
            <button class="btn ok" onclick="hideXpHistoryModal()">Fechar</button>
      </div>
    </div>
  </div>

  <div id="edit-item-modal" class="modal-overlay">
    <div class="modal-content">
      <h3>Editar Item</h3>
      <div id="edit-item-fields">
        <div>
          <label for="edit_nome">Nome</label>
          <input id="edit_nome" />
        </div>
        <div>
          <label for="edit_lvl">Nível</label>
          <input id="edit_lvl" type="number" min="1" max="6" />
        </div>
        <div>
          <label for="edit_usos">Usos</label>
          <input id="edit_usos" type="number" min="0" />
        </div>
        <div>
          <label for="edit_bonus">Bônus (+xD6)</label>
          <input id="edit_bonus" type="number" min="0" />
        </div>
        <div style="margin-top: 10px;">
          <label for="edit_fx">Efeito</label>
          <textarea id="edit_fx"></textarea>
        </div>
        <div style="margin-top: 10px;">
          <label for="arvore_vinculada_edit">Vincular a Árvore</label>
          <select id="arvore_vinculada_edit"></select>
        </div>
      </div>
      <div class="actions" style="margin-top: 12px;">
        <button class="btn ok" onclick="salvarEdicaoItem()">Salvar</button>
        <button class="btn ghost" onclick="hideEditItemModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="image-cropper-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Ajustar Foto</h3>
        <div class="image-cropper-container">
            <img id="image-to-crop" src="" alt="Imagem para recortar">
        </div>
        <div class="actions" style="margin-top: 12px; align-items: center;">
            <div class="move-btn-group" style="margin-right: 12px;">
                <button class="move-btn up" onmousedown="startMove(0, -1)" onmouseup="stopMove()" onmouseleave="stopMove()" ontouchstart="startMove(0, -1)" ontouchend="stopMove()">&#x25B2;</button>
                <button class="move-btn left" onmousedown="startMove(-1, 0)" onmouseup="stopMove()" onmouseleave="stopMove()" ontouchstart="startMove(-1, 0)" ontouchend="stopMove()">&#x25C0;</button>
                <button class="move-btn right" onmousedown="startMove(1, 0)" onmouseup="stopMove()" onmouseleave="stopMove()" ontouchstart="startMove(1, 0)" ontouchend="stopMove()">&#x25B6;</button>
                <button class="move-btn down" onmousedown="startMove(0, 1)" onmouseup="stopMove()" onmouseleave="stopMove()" ontouchstart="startMove(0, 1)" ontouchend="stopMove()">&#x25BC;</button>
            </div>
            <div class="row">
                <button class="btn" id="zoom-out-btn" onmousedown="startZoom(-0.1)" onmouseup="stopMove()" onmouseleave="stopMove()" ontouchstart="startZoom(-0.1)" ontouchend="stopMove()">-</button>
                <button class="btn" id="zoom-in-btn" onmousedown="startZoom(0.1)" onmouseup="stopMove()" onmouseleave="stopMove()" ontouchstart="startZoom(0.1)" ontouchend="stopMove()">+</button>
            </div>
            <div class="row" style="margin-top: 12px;">
                <button class="btn ok" onclick="cropAndSaveImage()">Salvar</button>
                <button class="btn danger" onclick="cancelCrop()">Cancelar</button>
            </div>
        </div>
    </div>
  </div>
  
  <!-- Modal de Compra de Itens -->
  <div id="buy-item-modal" class="modal-overlay modal-with-scroll">
    <div class="modal-content">
      <h3>Loja de Itens</h3>
      <p class="muted small">Seu nível atual é: <span id="player-level-shop"></span></p>
      <div id="buy-item-list" class="list" style="margin-top: 10px;"></div>
      <div class="actions" style="margin-top: 12px;">
        <button class="btn ghost" onclick="hideBuyItemModal()">Fechar</button>
      </div>
    </div>
  </div>


  <!-- PERSONAGEM -->
  <section class="card" id="sec-personagem">
    <div class="row">
      <div class="col" style="flex: 0 0 120px;">
          <label for="p_foto_upload">Foto de Perfil</label>
          <img id="p_foto_img" src="https://placehold.co/100x100" class="profile-pic" alt="Foto de Perfil">
          <input type="file" id="p_foto_upload" style="display: none;" accept="image/*">
          <div class="row" style="margin-top: 8px;">
            <label for="p_foto_upload" class="btn ghost" style="text-align:center; cursor:pointer; flex: 1;">Upload</label>
            <button class="btn ghost" id="btn-edit-photo" onclick="editProfilePic()">Editar</button>
          </div>
      </div>
      <div class="col">
        <label for="p_nome">Nome</label>
        <input id="p_nome" placeholder="Nome do Personagem" onchange="updateCharacterDetails()" />
        <label for="p_raca" style="margin-top: 8px;">Raça</label>
        <input id="p_raca" placeholder="Ex.: Humano" onchange="updateCharacterDetails()" />
        <label for="p_classe" style="margin-top: 8px;">Classe</label>
        <input id="p_classe" placeholder="Ex.: Guerreiro" onchange="updateCharacterDetails()" />
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <div class="col">
        <label for="p_nivel">Nível</label>
        <select id="p_nivel" onchange="updateCharacterLevel()">
          <option value="1">Nível 1</option>
          <option value="2">Nível 2</option>
          <option value="3">Nível 3</option>
          <option value="4">Nível 4</option>
          <option value="5">Nível 5</option>
          <option value="6">Nível 6</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <div class="col">
        <label for="p_pv">PV</label>
        <div class="counter">
          <button class="btn ghost" onclick="inc('p_pv',-1)">−</button>
          <div class="val" id="p_pv_val">6 / 6</div>
          <button class="btn ghost" onclick="inc('p_pv',1)">+</button>
        </div>
      </div>
      <div class="col">
        <label for="p_ps">PS</label>
        <div class="counter">
          <button class="btn ghost" onclick="inc('p_ps',-1)">−</button>
          <div class="val" id="p_ps_val">6 / 6</div>
          <button class="btn ghost" onclick="inc('p_ps',1)">+</button>
        </div>
      </div>
      <div class="col">
        <label for="p_escudos">ESC</label>
        <div class="counter">
          <button class="btn ghost" onclick="inc('p_escudos',-1)">−</button>
          <div class="val" id="p_escudos_val">0 / 6</div>
          <button class="btn ghost" onclick="inc('p_escudos',1)">+</button>
        </div>
      </div>
      <div class="col" style="flex: none; width: 100%;">
        <label for="p_xp">XP</label>
        <div class="counter">
          <input id="p_xp_input" type="number" value="0" style="width: auto; flex: 1;" onchange="updateXpManually()">
          <button class="btn ghost" onclick="showXpHistoryModal()">Histórico</button>
        </div>
        <div class="row wrap" style="margin-top: 8px;">
          <button class="btn ghost" onclick="showXpModal(1)">+1</button>
          <button class="btn ghost" onclick="showXpModal(2)">+2</button>
          <button class="btn ghost" onclick="showXpModal(5)">+5</button>
          <button class="btn ghost" onclick="showXpModal(10)">+10</button>
          <button class="btn ghost" onclick="showXpModal(50)">+50</button>
        </div>
      </div>
    </div>
  </section>

  <!-- TESTES GENÉRICOS -->
  <section class="card" id="sec-testes">
    <h3 style="margin:0 0 8px 0;">🎲 Testes Genéricos</h3>
    <div class="row wrap" id="generic-test-buttons">
      <!-- Botões de teste genérico serão renderizados aqui -->
    </div>
    <div class="sep"></div>
    <div class="actions">
      <button class="btn ghost" onclick="rolarDadosLivres(4)">D4</button>
      <button class="btn ghost" onclick="rolarDadosLivres(6)">D6</button>
      <button class="btn ghost" onclick="rolarDadosLivres(8)">D8</button>
      <button class="btn ghost" onclick="rolarDadosLivres(10)">D10</button>
      <button class="btn ghost" onclick="rolarDadosLivres(12)">D12</button>
      <button class="btn ghost" onclick="rolarDadosLivres(20)">D20</button>
    </div>
    <div id="area-rolagem"></div>
  </section>

  <!-- ÁRVORES DE HABILIDADE -->
  <section class="card">
    <div class="row" style="justify-content: space-between;">
      <h3 style="margin:0;">🌳 Árvores de Habilidade</h3>
      <div class="actions">
        <button class="btn ghost" onclick="showAllCaracteristicasModal()">📖 Ver Características</button>
        <button class="btn" onclick="addArvore()">➕ Adicionar Árvore</button>
        <button class="btn ghost" onclick="showManualModal()">⚙️ Ferramentas Manuais</button>
      </div>
    </div>
    <div class="list" id="lista-arvores"></div>
  </section>

  <!-- INVENTÁRIO -->
  <section class="card" id="sec-inventario">
    <div class="row" style="justify-content: space-between;">
      <h3 style="margin:0;">🎒 Inventário</h3>
      <div class="actions">
        <button class="btn" onclick="showBuyItemModal()">💰 Comprar Itens</button>
      </div>
    </div>
    <div class="list" id="lista-itens"></div>
  </section>
  
  <!-- GERAÇÃO DE CONTEÚDO COM IA -->
  <section class="card" id="sec-gemini">
      <h3 style="margin:0 0 8px 0;">✨ Geração de Conteúdo com IA</h3>
      <div class="col">
          <label for="gemini_prompt">Descreva o que deseja gerar:</label>
          <textarea id="gemini_prompt" placeholder="Ex: Crie uma história de origem para um cavaleiro que perdeu sua memória e agora busca redenção."></textarea>
      </div>
      <div class="actions" style="margin-top: 8px;">
          <button class="btn ok" onclick="generateContentWithGemini()">Gerar Conteúdo</button>
          <div id="gemini-loading" style="display: none; padding: 10px; color: var(--muted);">
              Gerando...
          </div>
      </div>
  </section>

  <!-- NOTAS -->
  <section class="card">
    <label for="p_conceito">Conceito e História</label>
    <textarea id="p_conceito" placeholder="Ex.: Cavaleiro honrado em busca de redenção..." onchange="updateCharacterDetails()"></textarea>
    <label for="p_notas" style="margin-top:8px;">Notas Adicionais</label>
    <textarea id="p_notas" placeholder="Anotações rápidas..." onchange="updateCharacterDetails()"></textarea>
  </section>

  <!-- EXPORT / IMPORT / RESET -->
  <section class="card">
    <div class="actions">
      <button class="btn ok" onclick="exportar()">⬇️ Exportar JSON</button>
      <label class="btn ghost" for="imp" style="cursor:pointer;">⬆️ Importar JSON</label>
      <input id="imp" type="file" accept="application/json" style="display:none" onchange="importar(event)" />
      <button class="btn danger right" onclick="resetar()">🗑️ Resetar Ficha</button>
    </div>
    <div class="muted small">Dados ficam apenas no seu dispositivo (LocalStorage).</div>
    <div class="actions" style="margin-top: 12px;">
      <button class="btn ok" onclick="gerarPdfFicha()">Gerar PDF da Ficha</button>
    </div>
  </section>

</main>

<!-- PDF version (hidden from view) -->
<div id="printable-content" style="display: none;">
  <div style="display: flex; flex-direction: column; padding: 20px; font-family: sans-serif; color: #000; height: 100%;">
    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
      <div style="flex: 0 0 100px; height: 100px; border: 1px solid #000; overflow: hidden; position: relative;">
        <img id="print-foto-img" style="width: 100px; height: 100px; position: absolute; transform-origin: 0 0;">
      </div>
      <div style="flex: 1;">
        <h2 style="margin: 0; font-size: 24px;">Ficha de Personagem</h2>
        <p style="margin: 0; font-size: 14px;">Nome: <span id="print-nome"></span></p>
        <p style="margin: 0; font-size: 14px;">Raça: <span id="print-raca"></span></p>
        <p style="margin: 0; font-size: 14px;">Classe: <span id="print-classe"></span></p>
      </div>
    </div>
    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
      <div style="flex: 1;">
        <h3 style="border-bottom: 1px solid #000; margin: 0 0 10px 0; font-size: 18px;">Atributos</h3>
        <p style="margin: 0;">Nível: <span id="print-nivel"></span></p>
        <p style="margin: 0;">XP: <span id="print-xp"></span></p>
        <p style="margin: 0;">PV: <span id="print-pv"></span></p>
        <p style="margin: 0;">PS: <span id="print-ps"></span></p>
        <p style="margin: 0;">ESC: <span id="print-escudos"></span></p>
      </div>
    </div>
    <div style="flex: 1;">
        <h3 style="border-bottom: 1px solid #000; margin: 0 0 10px 0; font-size: 18px;">Árvores de Habilidade</h3>
        <div id="print-arvores-list"></div>
    </div>
    <div style="flex: 1;">
        <h3 style="border-bottom: 1px solid #000; margin: 0 0 10px 0; font-size: 18px;">Inventário</h3>
        <div id="print-itens-list"></div>
    </div>
    <div style="flex: 1;">
      <h3 style="border-bottom: 1px solid #000; margin: 0 0 10px 0; font-size: 18px;">No